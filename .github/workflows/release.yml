# 自动打包 Linux / macOS / Windows 并创建 GitHub Release（Moss 方案：构建后单独签名）
# 详见项目根目录 DEPLOY.md
name: release

on:
  workflow_dispatch:
  push:
    branches:
      - release
    tags:
      - "v*"

jobs:
  build:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            args: --target aarch64-apple-darwin
            platform_key: darwin-aarch64
            rust_target: aarch64-apple-darwin
          - platform: macos-latest
            args: --target x86_64-apple-darwin
            platform_key: darwin-x86_64
            rust_target: x86_64-apple-darwin
          - platform: ubuntu-22.04
            args: "--bundles appimage"
            platform_key: linux-x86_64
            rust_target: x86_64-unknown-linux-gnu
          - platform: windows-latest
            args: ""
            platform_key: windows-x86_64
            rust_target: x86_64-pc-windows-msvc
    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "pnpm"

      - name: install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"

      - name: install frontend dependencies
        run: pnpm install

      - name: sync version to Cargo.toml
        run: pnpm version:sync

      # Moss 方案：禁用 createUpdaterArtifacts，构建时不需要签名密钥
      - name: disable createUpdaterArtifacts
        run: |
          node -e "
          const fs = require('fs');
          const conf = JSON.parse(fs.readFileSync('src-tauri/tauri.conf.json', 'utf8'));
          conf.bundle.createUpdaterArtifacts = false;
          fs.writeFileSync('src-tauri/tauri.conf.json', JSON.stringify(conf, null, 2));
          console.log('createUpdaterArtifacts disabled');
          "

      - name: build
        run: pnpm tauri build ${{ matrix.args }}

      # 构建后手动创建 updater 产物并用 tauri signer sign 签名
      - name: create and sign updater artifacts
        env:
          TAURI_SIGNING_PRIVATE_KEY_BASE64: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_BASE64 }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: |
          node scripts/create-and-sign-updater.mjs ${{ matrix.platform_key }} ${{ matrix.rust_target }}

      - name: upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.platform_key }}
          path: src-tauri/target/${{ matrix.rust_target }}/release/bundle/

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: merge latest.json
        run: |
          node scripts/merge-latest-json.mjs \
            artifacts/build-darwin-aarch64 \
            artifacts/build-darwin-x86_64 \
            artifacts/build-linux-x86_64 \
            artifacts/build-windows-x86_64

      - name: flatten release assets
        run: node scripts/flatten-release-assets.mjs

      - name: read version
        id: version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: app-v${{ steps.version.outputs.version }}
          name: XY Todo List v${{ steps.version.outputs.version }}
          body: |
            ## 更新内容
            请查看 [CHANGELOG](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)。
            在下方 Assets 中下载对应平台的安装包。
          draft: true
          prerelease: false
          files: release-assets/*
